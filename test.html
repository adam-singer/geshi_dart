<pre class="dart"><span style="color: #808080; font-style: italic;">// Copyright (c) 2011, the Dart project authors.  Please see the AUTHORS file</span>
<span style="color: #808080; font-style: italic;">// for details. All rights reserved. Use of this source code is governed by a</span>
<span style="color: #808080; font-style: italic;">// BSD-style license that can be found in the LICENSE file.</span>
&nbsp;
<span style="color: #808080; font-style: italic;">// TODO(jimhug): Error recovery needs major work!</span>
<span style="color: #808080; font-style: italic;">/**
 * A simple recursive descent parser for the dart language.
 *
 * This parser is designed to be more permissive than the official
 * Dart grammar.  It is expected that many grammar errors would be
 * reported by a later compiler phase.  For example, a class is allowed
 * to extend an arbitrary number of base classes - this can be
 * very clearly detected and is reported in a later compiler phase.
 */</span>
<span style="color: #0055FF; font-weight: bold;">class</span> Parser <span style="color: #000033;">&#123;</span>
  TokenSource tokenizer;
&nbsp;
  <span style="color: #0055FF; font-weight: bold;">final</span> SourceFile source;
  <span style="color: #808080; font-style: italic;">/** Enables diet parse, which skips function bodies. */</span>
  <span style="color: #0055FF; font-weight: bold;">final</span> <span style="color: #0055FF;">bool</span> diet;
  <span style="color: #808080; font-style: italic;">/**
   * Throw an IncompleteSourceException if the parser encounters a premature end
   * of file or an incomplete multiline string.
   */</span>
  <span style="color: #0055FF; font-weight: bold;">final</span> <span style="color: #0055FF;">bool</span> throwOnIncomplete;
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Allow semicolons to be omitted at the end of lines. */</span>
  <span style="color: #808080; font-style: italic;">// TODO(nweiz): make this work for more than just end-of-file</span>
  <span style="color: #0055FF; font-weight: bold;">final</span> <span style="color: #0055FF;">bool</span> optionalSemicolons;
&nbsp;
  <span style="color: #808080; font-style: italic;">/**
   * Allow the await keyword, when the await transformation is available (see
   * await/awaitc.dart).
   */</span>
  <span style="color: #0055FF;">bool</span> get enableAwait<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> =&gt; experimentalAwaitPhase != <span style="color: #0055FF; font-weight: bold;">null</span>;
&nbsp;
  <span style="color: #808080; font-style: italic;">/**
   * To resolve ambiguity in initializers between constructor body and lambda
   * expression.
   */</span>
  <span style="color: #0055FF;">bool</span> _inhibitLambda = <span style="color: #0055FF; font-weight: bold;">false</span>;
&nbsp;
  Token _previousToken;
  Token _peekToken;
&nbsp;
  <span style="color: #808080; font-style: italic;">// When we encounter '(' in a method body we need to find the ')' to know it</span>
  <span style="color: #808080; font-style: italic;">// we're parsing a lambda, paren-expr, or argument list. Closure formals are</span>
  <span style="color: #808080; font-style: italic;">// followed by '=&gt;' or '{'. This list is used to cache the tokens after any</span>
  <span style="color: #808080; font-style: italic;">// nested parenthesis we find while peeking.</span>
  <span style="color: #808080; font-style: italic;">// TODO(jmesserly): it's simpler and faster to cache this on the Token itself,</span>
  <span style="color: #808080; font-style: italic;">// but that might add too much complexity for tools that need to invalidate.</span>
  List&lt;Token&gt; _afterParens;
  <span style="color: #0055FF;">int</span> _afterParensIndex = <span style="color: #cc66cc;">0</span>;
&nbsp;
  <span style="color: #0055FF;">bool</span> _recover = <span style="color: #0055FF; font-weight: bold;">false</span>;
&nbsp;
  Parser<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">source</span>, <span style="color: #000033;">&#91;</span><span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">diet</span> = <span style="color: #0055FF; font-weight: bold;">false</span>, <span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">throwOnIncomplete</span> = <span style="color: #0055FF; font-weight: bold;">false</span>,
      <span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">optionalSemicolons</span> = <span style="color: #0055FF; font-weight: bold;">false</span>, <span style="color: #0055FF;">int</span> startOffset = <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    tokenizer = <span style="color: #0055FF; font-weight: bold;">new</span> Tokenizer<span style="color: #000033;">&#40;</span>source, <span style="color: #0055FF; font-weight: bold;">true</span>, startOffset<span style="color: #000033;">&#41;</span>;
    _peekToken = tokenizer.<span style="">next</span><span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _afterParens = &lt;Token&gt;<span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Generate an error if [source] has not been completely consumed. */</span>
  <span style="color: #0055FF;">void</span> checkEndOfFile<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Guard to break out of parser when an unexpected end of file is found. */</span>
  <span style="color: #0055FF;">bool</span> isPrematureEndOfFile<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>throwOnIncomplete &amp;&amp; _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">throw</span> <span style="color: #0055FF; font-weight: bold;">new</span> IncompleteSourceException<span style="color: #000033;">&#40;</span>_previousToken<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'unexpected end of file'</span>, _peekToken.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">true</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/**
   * Recovers the parser after an error, by iterating until it finds one of
   * the provide [TokenKind] values.
   */</span>
  <span style="color: #0055FF;">bool</span> _recoverTo<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> kind1, <span style="color: #000033;">&#91;</span><span style="color: #0055FF;">int</span> kind2, <span style="color: #0055FF;">int</span> kind3<span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">assert</span><span style="color: #000033;">&#40;</span>_recover<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!isPrematureEndOfFile<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">int</span> kind = _peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == kind1 || kind == kind2 || kind == kind3<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _recover = <span style="color: #0055FF; font-weight: bold;">false</span>; <span style="color: #808080; font-style: italic;">// Done recovering. Issue errors normally.</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">true</span>;
      <span style="color: #000033;">&#125;</span>
      _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #808080; font-style: italic;">// End of file without finding a match</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">false</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// Basic support methods</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #0055FF;">int</span> _peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> =&gt; _peekToken.<span style="">kind</span>;
&nbsp;
  Token _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _previousToken = _peekToken;
    _peekToken = tokenizer.<span style="">next</span><span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> _previousToken;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">bool</span> _peekKind<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> kind<span style="color: #000033;">&#41;</span> =&gt; _peekToken.<span style="">kind</span> == kind;
&nbsp;
  <span style="color: #808080; font-style: italic;">/* Is the next token a legal identifier?  This includes pseudo-keywords. */</span>
  <span style="color: #0055FF;">bool</span> _peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> =&gt; _isIdentifier<span style="color: #000033;">&#40;</span>_peekToken.<span style="">kind</span><span style="color: #000033;">&#41;</span>;
&nbsp;
  <span style="color: #0055FF;">bool</span> _isIdentifier<span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> TokenKind.<span style="">isIdentifier</span><span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span>
      <span style="color: #808080; font-style: italic;">// Note: 'await' is not a pseudo-keyword. When [enableAwait] is true, it</span>
      <span style="color: #808080; font-style: italic;">// is illegal to consider 'await' an identifier.</span>
      || <span style="color: #000033;">&#40;</span>!enableAwait &amp;&amp; kind == TokenKind.<span style="">AWAIT</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">bool</span> _maybeEat<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekToken.<span style="">kind</span> == kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _previousToken = _peekToken;
      _peekToken = tokenizer.<span style="">next</span><span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">true</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">void</span> _eat<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span>TokenKind.<span style="">kindToString</span><span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">void</span> _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>optionalSemicolons &amp;&amp; _peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">void</span> _errorExpected<span style="color: #000033;">&#40;</span>String expected<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// Throw an IncompleteSourceException if that's the problem and</span>
    <span style="color: #808080; font-style: italic;">// throwOnIncomplete is true</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>throwOnIncomplete<span style="color: #000033;">&#41;</span> isPrematureEndOfFile<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tok is ErrorToken &amp;&amp; tok.<span style="">message</span> != <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// give priority to tokenizer errors</span>
      _error<span style="color: #000033;">&#40;</span>tok.<span style="">message</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expected $expected, but found $tok'</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">void</span> _error<span style="color: #000033;">&#40;</span>String message, <span style="color: #000033;">&#91;</span>SourceSpan location=<span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// Suppress error messages while we're trying to recover.</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_recover<span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span>;
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>location == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      location = _peekToken.<span style="">span</span>;
    <span style="color: #000033;">&#125;</span>
    world.<span style="">fatal</span><span style="color: #000033;">&#40;</span>message, location<span style="color: #000033;">&#41;</span>; <span style="color: #808080; font-style: italic;">// syntax errors are fatal for now</span>
    _recover = <span style="color: #0055FF; font-weight: bold;">true</span>; <span style="color: #808080; font-style: italic;">// start error recovery</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Skips from an opening '{' to the syntactically matching '}'. */</span>
  <span style="color: #0055FF;">void</span> _skipBlock<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> depth = <span style="color: #cc66cc;">1</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tok.<span style="">kind</span> == TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        depth += <span style="color: #cc66cc;">1</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tok.<span style="">kind</span> == TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        depth -= <span style="color: #cc66cc;">1</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>depth == <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tok.<span style="">kind</span> == TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'unexpected end of file during diet parse'</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  SourceSpan _makeSpan<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> SourceSpan<span style="color: #000033;">&#40;</span>source, start, _previousToken.<span style="">end</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// Top level productions</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Entry point to the parser for parsing a compilation unit (i.e. a file). */</span>
  List&lt;Definition&gt; compilationUnit<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> ret = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">HASHBANG</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">HASH</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      ret.<span style="">add</span><span style="color: #000033;">&#40;</span>directive<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    _recover = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      ret.<span style="">add</span><span style="color: #000033;">&#40;</span>topLevelDefinition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    _recover = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> ret;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  directive<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">HASH</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> args = arguments<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> DirectiveDefinition<span style="color: #000033;">&#40;</span>name, args, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  topLevelDefinition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">switch</span> <span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">CLASS</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> classDefinition<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">CLASS</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">INTERFACE</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> classDefinition<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">INTERFACE</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">TYPEDEF</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> functionTypeAlias<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> declaration<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Entry point to the parser for an eval unit (i.e. a repl command). */</span>
  evalUnit<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">switch</span> <span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">CLASS</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> classDefinition<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">CLASS</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">INTERFACE</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> classDefinition<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">INTERFACE</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">TYPEDEF</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> functionTypeAlias<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    _recover = <span style="color: #0055FF; font-weight: bold;">false</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// Definition productions</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
&nbsp;
  classDefinition<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> name = identifierForType<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">var</span> typeParams = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      typeParams = typeParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> _extends = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">EXTENDS</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _extends = typeList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> _implements = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">IMPLEMENTS</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _implements = typeList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> _native = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">NATIVE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _native = maybeStringLiteral<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_native != <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> _native = <span style="color: #0055FF; font-weight: bold;">new</span> NativeType<span style="color: #000033;">&#40;</span>_native<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">bool</span> oldFactory = _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">FACTORY</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> defaultType = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>oldFactory || _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">DEFAULT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// TODO(jmesserly): keep old factory support for now. Remove soon.</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>oldFactory<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        world.<span style="">warning</span><span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'factory no longer supported, use &quot;default&quot; instead'</span>,
            _previousToken.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
&nbsp;
      <span style="color: #808080; font-style: italic;">// Note: this can't be type() because it has type parameters not type</span>
      <span style="color: #808080; font-style: italic;">// arguments.</span>
      <span style="color: #0055FF;">var</span> baseType = nameTypeReference<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> factTypeParams = <span style="color: #0055FF; font-weight: bold;">null</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        factTypeParams = typeParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      defaultType = <span style="color: #0055FF; font-weight: bold;">new</span> DefaultTypeReference<span style="color: #000033;">&#40;</span>oldFactory,
          baseType, factTypeParams, _makeSpan<span style="color: #000033;">&#40;</span>baseType.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> body = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        body.<span style="">add</span><span style="color: #000033;">&#40;</span>declaration<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_recover<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_recoverTo<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span>, TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">break</span>;
          _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span>
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'block starting with &quot;{&quot; or &quot;;&quot;'</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> TypeDefinition<span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="color: #0055FF; font-weight: bold;">CLASS</span>, name, typeParams,
      _extends, _implements, _native, defaultType, body, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  functionTypeAlias<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">TYPEDEF</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">var</span> di = declaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> typeParams = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      typeParams = typeParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> formals = formalParameterList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">// TODO(jimhug): Validate that di.name is not a pseudo-keyword</span>
    <span style="color: #0055FF;">var</span> func = <span style="color: #0055FF; font-weight: bold;">new</span> FunctionDefinition<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span>, di.<span style="">type</span>, di.<span style="">name</span>, formals,
        <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> FunctionTypeDefinition<span style="color: #000033;">&#40;</span>func, typeParams, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  initializers<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _inhibitLambda = <span style="color: #0055FF; font-weight: bold;">true</span>;
    <span style="color: #0055FF;">var</span> ret = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">do</span> <span style="color: #000033;">&#123;</span>
      ret.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    _inhibitLambda = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> ret;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  functionBody<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">bool</span> inExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ARROW</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!inExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ReturnStatement<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>diet<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _skipBlock<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> DietStatement<span style="color: #000033;">&#40;</span>_makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> block<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!inExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
&nbsp;
    _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'Expected function body (neither { nor =&gt; found)'</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishField<span style="color: #000033;">&#40;</span>start, modifiers, type, name, value<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> names = <span style="color: #000033;">&#91;</span>name<span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">var</span> values = <span style="color: #000033;">&#91;</span>value<span style="color: #000033;">&#93;</span>;
&nbsp;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      names.<span style="">add</span><span style="color: #000033;">&#40;</span>identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ASSIGN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        values.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        values.<span style="">add</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
&nbsp;
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> VariableDefinition<span style="color: #000033;">&#40;</span>modifiers, type, names, values,
                                   _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishDefinition<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start, List&lt;Token&gt; modifiers, di<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">switch</span><span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LPAREN</span>:
        <span style="color: #0055FF;">var</span> formals = formalParameterList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> inits = <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">native</span> = <span style="color: #0055FF; font-weight: bold;">null</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          inits = initializers<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">NATIVE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">native</span> = maybeStringLiteral<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">native</span> == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">native</span> = <span style="color: #ff0000;">''</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF;">var</span> body = functionBody<span style="color: #000033;">&#40;</span><span style="color: #808080; font-style: italic;">/*inExpression:*/</span><span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>di.<span style="">name</span> == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #808080; font-style: italic;">// TODO(jimhug): Must be named constructor - verify how?</span>
          di.<span style="">name</span> = di.<span style="">type</span>.<span style="">name</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> FunctionDefinition<span style="color: #000033;">&#40;</span>modifiers, di.<span style="">type</span>, di.<span style="">name</span>, formals,
          inits, <span style="color: #0055FF; font-weight: bold;">native</span>, body, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">ASSIGN</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ASSIGN</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> value = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> finishField<span style="color: #000033;">&#40;</span>start, modifiers, di.<span style="">type</span>, di.<span style="">name</span>, value<span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">COMMA</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">SEMICOLON</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> finishField<span style="color: #000033;">&#40;</span>start, modifiers, di.<span style="">type</span>, di.<span style="">name</span>, <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #808080; font-style: italic;">// TODO(jimhug): This error message sucks.</span>
        _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'declaration'</span><span style="color: #000033;">&#41;</span>;
&nbsp;
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  declaration<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#91;</span><span style="color: #0055FF;">bool</span> includeOperators=<span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">FACTORY</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> factoryConstructorDeclaration<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> modifiers = _readModifiers<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> finishDefinition<span style="color: #000033;">&#40;</span>start, modifiers,
        declaredIdentifier<span style="color: #000033;">&#40;</span>includeOperators<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">// TODO(jmesserly): do we still need this method?</span>
  <span style="color: #808080; font-style: italic;">// I left it here for now to support old-style factories</span>
  factoryConstructorDeclaration<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> factoryToken = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">var</span> names = <span style="color: #000033;">&#91;</span>identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">DOT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      names.<span style="">add</span><span style="color: #000033;">&#40;</span>identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> tp = typeParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      world.<span style="">warning</span><span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'type parameters on factories are no longer supported, '</span>
          + <span style="color: #ff0000;">'place them on the class instead'</span>, _makeSpan<span style="color: #000033;">&#40;</span>tp<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> name = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">var</span> type = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">DOT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>names.<span style="">length</span> &gt; <span style="color: #cc66cc;">1</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        name = names.<span style="">removeLast</span><span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        name = <span style="color: #0055FF; font-weight: bold;">new</span> Identifier<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">''</span>, names<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>names.<span style="">length</span> &gt; <span style="color: #cc66cc;">1</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// TODO(jimhug): This is nasty to support and currently unused.</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'unsupported qualified name for factory'</span>, names<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    type = <span style="color: #0055FF; font-weight: bold;">new</span> NameTypeReference<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span>, names<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, names<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> di = <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span>type, name, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> finishDefinition<span style="color: #000033;">&#40;</span>start, <span style="color: #000033;">&#91;</span>factoryToken<span style="color: #000033;">&#93;</span>, di<span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// Statement productions</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  Statement statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">switch</span> <span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">BREAK</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> breakStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">CONTINUE</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> continueStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">RETURN</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> returnStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">THROW</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> throwStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">ASSERT</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> assertStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF;">WHILE</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> whileStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF;">DO</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> doStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF;">FOR</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> forStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF;">IF</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> ifStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF;">SWITCH</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> switchStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">TRY</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> tryStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LBRACE</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> block<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">SEMICOLON</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> emptyStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">FINAL</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> declaration<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">VAR</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> declaration<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #808080; font-style: italic;">// Covers var decl, func decl, labeled stmt and real expressions.</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> finishExpressionAsStatement<span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishExpressionAsStatement<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// TODO(jimhug): This method looks very inefficient - bundle tests.</span>
    <span style="color: #0055FF;">int</span> start = expr.<span style="">span</span>.<span style="">start</span>;
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> label = _makeLabel<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> LabeledStatement<span style="color: #000033;">&#40;</span>label, statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is LambdaExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr.<span style="">func</span>.<span style="">body</span> is! BlockStatement<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        expr.<span style="">func</span>.<span style="">span</span> = _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> expr.<span style="">func</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is DeclaredIdentifier<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> value = <span style="color: #0055FF; font-weight: bold;">null</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ASSIGN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        value = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> finishField<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">null</span>, expr.<span style="">type</span>, expr.<span style="">name</span>, value<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_isBin<span style="color: #000033;">&#40;</span>expr, TokenKind.<span style="">ASSIGN</span><span style="color: #000033;">&#41;</span> &amp;&amp;
               <span style="color: #000033;">&#40;</span>expr.<span style="">x</span> is DeclaredIdentifier<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      DeclaredIdentifier di = expr.<span style="">x</span>; <span style="color: #808080; font-style: italic;">// TODO(jimhug): inference should handle!</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> finishField<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">null</span>, di.<span style="">type</span>, di.<span style="">name</span>, expr.<span style="">y</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_isBin<span style="color: #000033;">&#40;</span>expr, TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span> &amp;&amp; _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> baseType = _makeType<span style="color: #000033;">&#40;</span>expr.<span style="">x</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> typeArgs = <span style="color: #000033;">&#91;</span>_makeType<span style="color: #000033;">&#40;</span>expr.<span style="">y</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#93;</span>;
      <span style="color: #0055FF;">var</span> gt = _finishTypeArguments<span style="color: #000033;">&#40;</span>baseType, <span style="color: #cc66cc;">0</span>, typeArgs<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> value = <span style="color: #0055FF; font-weight: bold;">null</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ASSIGN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        value = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> finishField<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, gt, name, value<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ExpressionStatement<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  Expression testCondition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> ret = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> ret;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Parses a block. Also is an entry point when parsing [DietStatement]. */</span>
  BlockStatement block<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> stmts = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      stmts.<span style="">add</span><span style="color: #000033;">&#40;</span>statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_recover &amp;&amp; !_recoverTo<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span>, TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">break</span>;
    <span style="color: #000033;">&#125;</span>
    _recover = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> BlockStatement<span style="color: #000033;">&#40;</span>stmts, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  EmptyStatement emptyStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> EmptyStatement<span style="color: #000033;">&#40;</span>_makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
&nbsp;
  IfStatement ifStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">IF</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> test = testCondition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> trueBranch = statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> falseBranch = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">ELSE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      falseBranch = statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> IfStatement<span style="color: #000033;">&#40;</span>test, trueBranch, falseBranch, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  WhileStatement whileStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">WHILE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> test = testCondition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> body = statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> WhileStatement<span style="color: #000033;">&#40;</span>test, body, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  DoStatement doStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">DO</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> body = statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">WHILE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> test = testCondition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> DoStatement<span style="color: #000033;">&#40;</span>body, test, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  forStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">FOR</span><span style="color: #000033;">&#41;</span>;
    _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">var</span> init = forInitializerStatement<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>init is ForInStatement<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> init;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> test = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      test = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> step = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      step.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        step.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> body = statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ForStatement<span style="color: #000033;">&#40;</span>init, test, step, body, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  forInitializerStatement<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> init = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #808080; font-style: italic;">// Weird code here is needed to handle generic type and for in</span>
      <span style="color: #808080; font-style: italic;">// TODO(jmesserly): unify with block in finishExpressionAsStatement</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span> &amp;&amp; _isBin<span style="color: #000033;">&#40;</span>init, TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> baseType = _makeType<span style="color: #000033;">&#40;</span>init.<span style="">x</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> typeArgs = <span style="color: #000033;">&#91;</span>_makeType<span style="color: #000033;">&#40;</span>init.<span style="">y</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#93;</span>;
        <span style="color: #0055FF;">var</span> gt = _finishTypeArguments<span style="color: #000033;">&#40;</span>baseType, <span style="color: #cc66cc;">0</span>, typeArgs<span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        init = <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span>gt, name, _makeSpan<span style="color: #000033;">&#40;</span>init.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
&nbsp;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">IN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> _finishForIn<span style="color: #000033;">&#40;</span>start, _makeDeclaredIdentifier<span style="color: #000033;">&#40;</span>init<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> finishExpressionAsStatement<span style="color: #000033;">&#40;</span>init<span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _finishForIn<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start, DeclaredIdentifier di<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> body = statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ForInStatement<span style="color: #000033;">&#40;</span>di, expr, body,
      _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  tryStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">TRY</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> body = block<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> catches = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
&nbsp;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">CATCH</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      catches.<span style="">add</span><span style="color: #000033;">&#40;</span>catchNode<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> finallyBlock = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">FINALLY</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      finallyBlock = block<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> TryStatement<span style="color: #000033;">&#40;</span>body, catches, finallyBlock, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  catchNode<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">CATCH</span><span style="color: #000033;">&#41;</span>;
    _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> exc = declaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> trace = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      trace = declaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> body = block<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> CatchNode<span style="color: #000033;">&#40;</span>exc, trace, body, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  switchStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">SWITCH</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> test = testCondition<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> cases = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      cases.<span style="">add</span><span style="color: #000033;">&#40;</span>caseNode<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> SwitchStatement<span style="color: #000033;">&#40;</span>test, cases, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _peekCaseEnd<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> kind = _peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #808080; font-style: italic;">//TODO(efortuna): also if the first is an identifier followed by a colon, we</span>
    <span style="color: #808080; font-style: italic;">//have a label for the case statement.</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> kind == TokenKind.<span style="">RBRACE</span> || kind == TokenKind.<span style="color: #0055FF;">CASE</span> ||
      kind == TokenKind.<span style="color: #0055FF; font-weight: bold;">DEFAULT</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  caseNode<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> label = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      label = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> cases = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF;">CASE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        cases.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">DEFAULT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        cases.<span style="">add</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>cases.<span style="">length</span> == <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'case or default'</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> stmts = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_peekCaseEnd<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      stmts.<span style="">add</span><span style="color: #000033;">&#40;</span>statement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_recover &amp;&amp; !_recoverTo<span style="color: #000033;">&#40;</span>
          TokenKind.<span style="">RBRACE</span>, TokenKind.<span style="color: #0055FF;">CASE</span>, TokenKind.<span style="color: #0055FF; font-weight: bold;">DEFAULT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> CaseNode<span style="color: #000033;">&#40;</span>label, cases, stmts, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  returnStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">RETURN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> expr;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      expr = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ReturnStatement<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  throwStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">THROW</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> expr;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SEMICOLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      expr = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ThrowStatement<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  assertStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">ASSERT</span><span style="color: #000033;">&#41;</span>;
    _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> AssertStatement<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  breakStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">BREAK</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> name = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> BreakStatement<span style="color: #000033;">&#40;</span>name, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  continueStatement<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">CONTINUE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> name = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    _eatSemicolon<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ContinueStatement<span style="color: #000033;">&#40;</span>name, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// Expression productions</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> infixExpression<span style="color: #000033;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _makeType<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is VarExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> NameTypeReference<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span>, expr.<span style="">name</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, expr.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is DotExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> type = _makeType<span style="color: #000033;">&#40;</span>expr.<span style="">self</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>type.<span style="">names</span> == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        type.<span style="">names</span> = <span style="color: #000033;">&#91;</span>expr.<span style="">name</span><span style="color: #000033;">&#93;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        type.<span style="">names</span>.<span style="">add</span><span style="color: #000033;">&#40;</span>expr.<span style="">name</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      type.<span style="">span</span> = expr.<span style="">span</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> type;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expected type reference'</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  infixExpression<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> precedence<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> finishInfixExpression<span style="color: #000033;">&#40;</span>unaryExpression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>, precedence<span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _finishDeclaredId<span style="color: #000033;">&#40;</span>type<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> finishPostfixExpression<span style="color: #000033;">&#40;</span>
      <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span>type, name, _makeSpan<span style="color: #000033;">&#40;</span>type.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/**
   * Takes an initial binary expression of A &lt; B and turns it into a
   * declared identifier included the A &lt; B piece in the type.
   */</span>
  _fixAsType<span style="color: #000033;">&#40;</span>BinaryExpression x<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">assert</span><span style="color: #000033;">&#40;</span>_isBin<span style="color: #000033;">&#40;</span>x, TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #808080; font-style: italic;">// TODO(jimhug): good errors when expectations are violated</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">GT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// The simple case of A &lt; B &gt; just becomes a generic type</span>
      <span style="color: #0055FF;">var</span> base = _makeType<span style="color: #000033;">&#40;</span>x.<span style="">x</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> typeParam = _makeType<span style="color: #000033;">&#40;</span>x.<span style="">y</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> type = <span style="color: #0055FF; font-weight: bold;">new</span> GenericTypeReference<span style="color: #000033;">&#40;</span>base, <span style="color: #000033;">&#91;</span>typeParam<span style="color: #000033;">&#93;</span>, <span style="color: #cc66cc;">0</span>,
        _makeSpan<span style="color: #000033;">&#40;</span>x.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> _finishDeclaredId<span style="color: #000033;">&#40;</span>type<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// The case of A &lt; B &lt; kicks off a lot more parsing.</span>
      <span style="color: #0055FF; font-weight: bold;">assert</span><span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">var</span> base = _makeType<span style="color: #000033;">&#40;</span>x.<span style="">x</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> paramBase = _makeType<span style="color: #000033;">&#40;</span>x.<span style="">y</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> firstParam = addTypeArguments<span style="color: #000033;">&#40;</span>paramBase, <span style="color: #cc66cc;">1</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">var</span> type;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>firstParam.<span style="">depth</span> &lt;= <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        type = <span style="color: #0055FF; font-weight: bold;">new</span> GenericTypeReference<span style="color: #000033;">&#40;</span>base, <span style="color: #000033;">&#91;</span>firstParam<span style="color: #000033;">&#93;</span>, <span style="color: #cc66cc;">0</span>,
          _makeSpan<span style="color: #000033;">&#40;</span>x.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        type = _finishTypeArguments<span style="color: #000033;">&#40;</span>base, <span style="color: #cc66cc;">0</span>, <span style="color: #000033;">&#91;</span>firstParam<span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">GT</span><span style="color: #000033;">&#41;</span>;
        type = <span style="color: #0055FF; font-weight: bold;">new</span> GenericTypeReference<span style="color: #000033;">&#40;</span>base, <span style="color: #000033;">&#91;</span>firstParam<span style="color: #000033;">&#93;</span>, <span style="color: #cc66cc;">0</span>,
          _makeSpan<span style="color: #000033;">&#40;</span>x.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> _finishDeclaredId<span style="color: #000033;">&#40;</span>type<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishInfixExpression<span style="color: #000033;">&#40;</span>Expression x, <span style="color: #0055FF;">int</span> precedence<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">int</span> kind = _peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> prec = TokenKind.<span style="">infixPrecedence</span><span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>prec &gt;= precedence<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="">LT</span> || kind == TokenKind.<span style="">GT</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_isBin<span style="color: #000033;">&#40;</span>x, TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
            <span style="color: #808080; font-style: italic;">// This must be a generic type according the the Dart grammar.</span>
            <span style="color: #808080; font-style: italic;">// This rule is in the grammar to forbid A &lt; B &lt; C and</span>
            <span style="color: #808080; font-style: italic;">// A &lt; B &gt; C as expressions both because they don't make sense</span>
            <span style="color: #808080; font-style: italic;">// and to make it easier to disambiguate the generic types.</span>
            <span style="color: #808080; font-style: italic;">// There are a number of other comparison operators that are</span>
            <span style="color: #808080; font-style: italic;">// also unallowed to nest in this way, but in the spirit of this</span>
            <span style="color: #808080; font-style: italic;">// &quot;friendly&quot; parser, those will be allowed until a later phase.</span>
            <span style="color: #0055FF; font-weight: bold;">return</span> _fixAsType<span style="color: #000033;">&#40;</span>x<span style="color: #000033;">&#41;</span>;
          <span style="color: #000033;">&#125;</span>
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF;">var</span> op = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>op.<span style="">kind</span> == TokenKind.<span style="">IS</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF;">var</span> isTrue = !_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">NOT</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #0055FF;">var</span> typeRef = type<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
          x = <span style="color: #0055FF; font-weight: bold;">new</span> IsExpression<span style="color: #000033;">&#40;</span>isTrue, x, typeRef, _makeSpan<span style="color: #000033;">&#40;</span>x.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #0055FF; font-weight: bold;">continue</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #808080; font-style: italic;">// Using prec + 1 ensures that a - b - c will group correctly.</span>
        <span style="color: #808080; font-style: italic;">// Using prec for ASSIGN ops ensures that a = b = c groups correctly.</span>
        <span style="color: #0055FF;">var</span> y = infixExpression<span style="color: #000033;">&#40;</span>prec == <span style="color: #cc66cc;">2</span> ? prec: prec<span style="color: #cc66cc;">+1</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>op.<span style="">kind</span> == TokenKind.<span style="">CONDITIONAL</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #808080; font-style: italic;">// Using prec for so &quot;a ? b : c ? d : e&quot; groups correctly as</span>
          <span style="color: #808080; font-style: italic;">// &quot;a ? b : (c ? d : e)&quot;</span>
          <span style="color: #0055FF;">var</span> z = infixExpression<span style="color: #000033;">&#40;</span>prec<span style="color: #000033;">&#41;</span>;
          x = <span style="color: #0055FF; font-weight: bold;">new</span> ConditionalExpression<span style="color: #000033;">&#40;</span>x, y, z, _makeSpan<span style="color: #000033;">&#40;</span>x.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          x = <span style="color: #0055FF; font-weight: bold;">new</span> BinaryExpression<span style="color: #000033;">&#40;</span>op, x, y, _makeSpan<span style="color: #000033;">&#40;</span>x.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span>
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> x;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _isPrefixUnaryOperator<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">switch</span><span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">ADD</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">SUB</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">NOT</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">BIT_NOT</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">INCR</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">DECR</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">true</span>;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  unaryExpression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #808080; font-style: italic;">// peek for prefixOperators and incrementOperators</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_isPrefixUnaryOperator<span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> expr = unaryExpression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> UnaryExpression<span style="color: #000033;">&#40;</span>tok, expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>enableAwait &amp;&amp; _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">AWAIT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> expr = unaryExpression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> AwaitExpression<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> finishPostfixExpression<span style="color: #000033;">&#40;</span>primary<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  argument<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> expr;
    <span style="color: #0055FF;">var</span> label = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ELLIPSIS</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      label = <span style="color: #0055FF; font-weight: bold;">new</span> Identifier<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'...'</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>label == <span style="color: #0055FF; font-weight: bold;">null</span> &amp;&amp; _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      label = _makeLabel<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span>;
      expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ArgumentNode<span style="color: #000033;">&#40;</span>label, expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  arguments<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> args = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> saved = _inhibitLambda;
    _inhibitLambda = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">do</span> <span style="color: #000033;">&#123;</span>
        args.<span style="">add</span><span style="color: #000033;">&#40;</span>argument<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
     _inhibitLambda = saved;
    <span style="color: #0055FF; font-weight: bold;">return</span> args;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishPostfixExpression<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">switch</span><span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LPAREN</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> finishCallOrLambdaExpression<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LBRACK</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACK</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> index = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACK</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> finishPostfixExpression<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">new</span> IndexExpression<span style="color: #000033;">&#40;</span>expr, index,
          _makeSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">DOT</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">DOT</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> ret = <span style="color: #0055FF; font-weight: bold;">new</span> DotExpression<span style="color: #000033;">&#40;</span>expr, name, _makeSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> finishPostfixExpression<span style="color: #000033;">&#40;</span>ret<span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">INCR</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">DECR</span>:
        <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> PostfixExpression<span style="color: #000033;">&#40;</span>expr, tok, _makeSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #808080; font-style: italic;">// These are pseudo-expressions supported for cover grammar</span>
      <span style="color: #808080; font-style: italic;">// must be forbidden when parsing initializers.</span>
      <span style="color: #808080; font-style: italic;">// TODO(jmesserly): is this still needed?</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">ARROW</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LBRACE</span>:
         <span style="color: #0055FF; font-weight: bold;">return</span> expr;
&nbsp;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">return</span> finishPostfixExpression<span style="color: #000033;">&#40;</span>
            <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span>_makeType<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span>, identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>,
              _makeSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">return</span> expr;
        <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishCallOrLambdaExpression<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_atClosureParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> formals = formalParameterList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> body = functionBody<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> _makeFunction<span style="color: #000033;">&#40;</span>expr, formals, body<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is DeclaredIdentifier<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'illegal target for call, did you mean to declare a function?'</span>,
          expr.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF;">var</span> args = arguments<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> finishPostfixExpression<span style="color: #000033;">&#40;</span>
          <span style="color: #0055FF; font-weight: bold;">new</span> CallExpression<span style="color: #000033;">&#40;</span>expr, args, _makeSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Checks if the given expression is a binary op of the given kind. */</span>
  _isBin<span style="color: #000033;">&#40;</span>expr, kind<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> expr is BinaryExpression &amp;&amp; expr.<span style="">op</span>.<span style="">kind</span> == kind;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _makeLiteral<span style="color: #000033;">&#40;</span>Value value<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> LiteralExpression<span style="color: #000033;">&#40;</span>value, value.<span style="">span</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  primary<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">switch</span> <span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">THIS</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">THIS</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ThisExpression<span style="color: #000033;">&#40;</span>_makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">SUPER</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">SUPER</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> SuperExpression<span style="color: #000033;">&#40;</span>_makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">CONST</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">CONST</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACK</span><span style="color: #000033;">&#41;</span> || _peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">INDEX</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">return</span> finishListLiteral<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">true</span>, <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">return</span> finishMapLiteral<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">true</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">return</span> finishTypedLiteral<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF; font-weight: bold;">return</span> finishNewExpression<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span>
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">NEW</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">NEW</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> finishNewExpression<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LPAREN</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> _parenOrLambda<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LBRACK</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">INDEX</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> finishListLiteral<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">false</span>, <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LBRACE</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> finishMapLiteral<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">false</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #808080; font-style: italic;">// Literals</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">NULL</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">NULL</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromNull</span><span style="color: #000033;">&#40;</span>_makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #808080; font-style: italic;">// TODO(jimhug): Make Literal creation less wasteful - no dup span/text.</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">TRUE</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">TRUE</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromBool</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">FALSE</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">FALSE</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromBool</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">HEX_INTEGER</span>:
        <span style="color: #0055FF;">var</span> t = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromInt</span><span style="color: #000033;">&#40;</span>t.<span style="">value</span>, t.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">INTEGER</span>:
        <span style="color: #0055FF;">var</span> t = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromInt</span><span style="color: #000033;">&#40;</span>Math.<span style="">parseInt</span><span style="color: #000033;">&#40;</span>t.<span style="">text</span><span style="color: #000033;">&#41;</span>, t.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">DOUBLE</span>:
        <span style="color: #0055FF;">var</span> t = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>
          Value.<span style="">fromDouble</span><span style="color: #000033;">&#40;</span>Math.<span style="">parseDouble</span><span style="color: #000033;">&#40;</span>t.<span style="">text</span><span style="color: #000033;">&#41;</span>, t.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">STRING</span>:
      <span style="color: #0055FF;">var</span> t = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromString</span><span style="color: #000033;">&#40;</span>t.<span style="">value</span>, t.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">STRING_PART</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> stringInterpolation<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">LT</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> finishTypedLiteral<span style="color: #000033;">&#40;</span>start, <span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">VOID</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">VAR</span>:
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">FINAL</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> declaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
&nbsp;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #808080; font-style: italic;">// TODO(jimhug): Better error message.</span>
          _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expression'</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> VarExpression<span style="color: #000033;">&#40;</span>identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  stringInterpolation<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> pieces = <span style="color: #0055FF; font-weight: bold;">new</span> List&lt;Expression&gt;<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> startQuote = <span style="color: #0055FF; font-weight: bold;">null</span>, endQuote = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">while</span><span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">STRING_PART</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> token = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      pieces.<span style="">add</span><span style="color: #000033;">&#40;</span>_makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromString</span><span style="color: #000033;">&#40;</span>token.<span style="">value</span>, token.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        pieces.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">THIS</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        pieces.<span style="">add</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">new</span> ThisExpression<span style="color: #000033;">&#40;</span>_previousToken.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF;">var</span> id = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        pieces.<span style="">add</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">new</span> VarExpression<span style="color: #000033;">&#40;</span>id, id.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tok.<span style="">kind</span> != TokenKind.<span style="">STRING</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'interpolated string'</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    pieces.<span style="">add</span><span style="color: #000033;">&#40;</span>_makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromString</span><span style="color: #000033;">&#40;</span>tok.<span style="">value</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> span = _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> StringInterpExpression<span style="color: #000033;">&#40;</span>pieces, span<span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  String maybeStringLiteral<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> kind = _peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="">STRING</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> t = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> t.<span style="">value</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="">STRING_PART</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'string literal, but found interpolated string start'</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _parenOrLambda<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_atClosureParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> formals = formalParameterList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> body = functionBody<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> func = <span style="color: #0055FF; font-weight: bold;">new</span> FunctionDefinition<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, formals, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>,
        body, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> LambdaExpression<span style="color: #000033;">&#40;</span>func, func.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> saved = _inhibitLambda;
      _inhibitLambda = <span style="color: #0055FF; font-weight: bold;">false</span>;
      <span style="color: #0055FF;">var</span> expr = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
      _inhibitLambda = saved;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ParenExpression<span style="color: #000033;">&#40;</span>expr, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">bool</span> _atClosureParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_inhibitLambda<span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">false</span>;
    Token after = _peekAfterCloseParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> after.<span style="">kind</span> == TokenKind.<span style="">ARROW</span> || after.<span style="">kind</span> == TokenKind.<span style="">LBRACE</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Eats an LPAREN, and advances our after-RPAREN lookahead. */</span>
  _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LPAREN</span><span style="color: #000033;">&#41;</span>;
    _afterParensIndex++;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  Token _peekAfterCloseParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_afterParensIndex &lt; _afterParens.<span style="">length</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> _afterParens<span style="color: #000033;">&#91;</span>_afterParensIndex<span style="color: #000033;">&#93;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;">// Reset the queue</span>
    _afterParensIndex = <span style="color: #cc66cc;">0</span>;
    _afterParens.<span style="">clear</span><span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">// Start copying tokens as we lookahead</span>
    <span style="color: #0055FF;">var</span> tokens = &lt;Token&gt;<span style="color: #000033;">&#91;</span>_next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#93;</span>; <span style="color: #808080; font-style: italic;">// LPAREN</span>
    _lookaheadAfterParens<span style="color: #000033;">&#40;</span>tokens<span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">// Put all the lookahead tokens back into the parser's token stream.</span>
    <span style="color: #0055FF;">var</span> after = _peekToken;
    tokens.<span style="">add</span><span style="color: #000033;">&#40;</span>after<span style="color: #000033;">&#41;</span>;
    tokenizer = <span style="color: #0055FF; font-weight: bold;">new</span> DivertedTokenSource<span style="color: #000033;">&#40;</span>tokens, <span style="color: #0055FF; font-weight: bold;">this</span>, tokenizer<span style="color: #000033;">&#41;</span>;
    _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;  <span style="color: #808080; font-style: italic;">// Re-synchronize parser lookahead state.</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> after;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/**
   * This scan for the matching RPAREN to the current LPAREN and saves this
   * result for all nested parentheses so we don't need to look-head again.
   */</span>
  _lookaheadAfterParens<span style="color: #000033;">&#40;</span>List&lt;Token&gt; tokens<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// Save a slot in the array. This will hold the token after the parens.</span>
    <span style="color: #0055FF;">int</span> saved = _afterParens.<span style="">length</span>;
    _afterParens.<span style="">add</span><span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span>; <span style="color: #808080; font-style: italic;">// save a slot</span>
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      Token token = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      tokens.<span style="">add</span><span style="color: #000033;">&#40;</span>token<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">int</span> kind = token.<span style="">kind</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="">RPAREN</span> || kind == TokenKind.<span style="">END_OF_FILE</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _afterParens<span style="color: #000033;">&#91;</span>saved<span style="color: #000033;">&#93;</span> = _peekToken;
        <span style="color: #0055FF; font-weight: bold;">return</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="">LPAREN</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #808080; font-style: italic;">// Scan anything inside these nested parenthesis</span>
        _lookaheadAfterParens<span style="color: #000033;">&#40;</span>tokens<span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _typeAsIdentifier<span style="color: #000033;">&#40;</span>type<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>type.<span style="">name</span>.<span style="">name</span> == <span style="color: #ff0000;">'void'</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'identifer, but found &quot;${type.name.name}&quot;'</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #808080; font-style: italic;">// TODO(jimhug): lots of errors to check for</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> type.<span style="">name</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _specialIdentifier<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">bool</span> includeOperators<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    String name;
&nbsp;
    <span style="color: #0055FF;">switch</span> <span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">ELLIPSIS</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ELLIPSIS</span><span style="color: #000033;">&#41;</span>;
        _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'rest no longer supported'</span>, _previousToken.<span style="">span</span><span style="color: #000033;">&#41;</span>;
        name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>.<span style="">name</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">THIS</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">THIS</span><span style="color: #000033;">&#41;</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">DOT</span><span style="color: #000033;">&#41;</span>;
        name = <span style="color: #ff0000;">'this.${identifier().name}'</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">GET</span>:
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!includeOperators<span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">GET</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          name = <span style="color: #ff0000;">'get:${identifier().name}'</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          name = <span style="color: #ff0000;">'get'</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">SET</span>:
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!includeOperators<span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SET</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          name = <span style="color: #ff0000;">'set:${identifier().name}'</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          name = <span style="color: #ff0000;">'set'</span>;
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">OPERATOR</span>:
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!includeOperators<span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">OPERATOR</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">var</span> kind = _peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>kind == TokenKind.<span style="">NEGATE</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          name = <span style="color: #ff0000;">':negate'</span>;
          _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          name = TokenKind.<span style="">binaryMethodName</span><span style="color: #000033;">&#40;</span>kind<span style="color: #000033;">&#41;</span>;
          <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>name == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
            <span style="color: #808080; font-style: italic;">// TODO(jimhug): This is a very useful error, but we have to</span>
            <span style="color: #808080; font-style: italic;">//   lose it because operator is a pseudo-keyword...</span>
            <span style="color: #808080; font-style: italic;">//_errorExpected('legal operator name, but found: ${tok}');</span>
            name = <span style="color: #ff0000;">'operator'</span>;
          <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
            _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #000033;">&#125;</span>
        <span style="color: #000033;">&#125;</span>
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> Identifier<span style="color: #000033;">&#40;</span>name, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">// always includes this and ... as legal names to simplify other code.</span>
  declaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#91;</span><span style="color: #0055FF;">bool</span> includeOperators=<span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> myType = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">var</span> name = _specialIdentifier<span style="color: #000033;">&#40;</span>includeOperators<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>name == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      myType = type<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      name = _specialIdentifier<span style="color: #000033;">&#40;</span>includeOperators<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>name == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekIdentifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>myType is NameTypeReference &amp;&amp; myType.<span style="">names</span> == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          name = _typeAsIdentifier<span style="color: #000033;">&#40;</span>myType<span style="color: #000033;">&#41;</span>;
          myType = <span style="color: #0055FF; font-weight: bold;">null</span>;
        <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #808080; font-style: italic;">// TODO(jimhug): Where do these errors get handled?</span>
        <span style="color: #000033;">&#125;</span>
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span>myType, name, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishNewExpression<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start, <span style="color: #0055FF;">bool</span> isConst<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> type = type<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> name = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">DOT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> args = arguments<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> NewExpression<span style="color: #000033;">&#40;</span>isConst, type, name, args, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishListLiteral<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start, <span style="color: #0055FF;">bool</span> isConst, TypeReference itemType<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">INDEX</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// This is an empty array.</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ListExpression<span style="color: #000033;">&#40;</span>isConst, itemType, <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> values = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACK</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACK</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      values.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_recover &amp;&amp; !_recoverTo<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACK</span>, TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACK</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ListExpression<span style="color: #000033;">&#40;</span>isConst, itemType, values, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishMapLiteral<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start, <span style="color: #0055FF;">bool</span> isConst,
      TypeReference keyType, TypeReference valueType<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> items = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #808080; font-style: italic;">// This is deliberately overly permissive - checked in later pass.</span>
      items.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COLON</span><span style="color: #000033;">&#41;</span>;
      items.<span style="">add</span><span style="color: #000033;">&#40;</span>expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_recover &amp;&amp; !_recoverTo<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span>, TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACE</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> MapExpression<span style="color: #000033;">&#40;</span>isConst, keyType, valueType, items,
      _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  finishTypedLiteral<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> start, <span style="color: #0055FF;">bool</span> isConst<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> span = _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">final</span> typeToBeNamedLater = <span style="color: #0055FF; font-weight: bold;">new</span> NameTypeReference<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, span<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">final</span> genericType = addTypeArguments<span style="color: #000033;">&#40;</span>typeToBeNamedLater, <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">final</span> typeArgs = genericType.<span style="">typeArguments</span>;
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACK</span><span style="color: #000033;">&#41;</span> || _peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">INDEX</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>typeArgs.<span style="">length</span> != <span style="color: #cc66cc;">1</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        world.<span style="">error</span><span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'exactly one type argument expected for list'</span>,
          genericType.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> finishListLiteral<span style="color: #000033;">&#40;</span>start, isConst, typeArgs<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACE</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> keyType, valueType;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>typeArgs.<span style="">length</span> == <span style="color: #cc66cc;">1</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        keyType = <span style="color: #0055FF; font-weight: bold;">null</span>;
        valueType = typeArgs<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>typeArgs.<span style="">length</span> == <span style="color: #cc66cc;">2</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        keyType = typeArgs<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span>;
        <span style="color: #808080; font-style: italic;">// making key explicit is just a warning.</span>
        world.<span style="">warning</span><span style="color: #000033;">&#40;</span>
            <span style="color: #ff0000;">'a map literal takes one type argument specifying the value type'</span>,
            keyType.<span style="">span</span><span style="color: #000033;">&#41;</span>;
        valueType = typeArgs<span style="color: #000033;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #000033;">&#93;</span>;
      <span style="color: #000033;">&#125;</span> <span style="color: #808080; font-style: italic;">// o.w. the type system will detect the mismatch in type arguments.</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> finishMapLiteral<span style="color: #000033;">&#40;</span>start, isConst, keyType, valueType<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'array or map literal'</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// Some auxilary productions.</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  _readModifiers<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> modifiers = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">true</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">switch</span><span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">STATIC</span>:
        <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">FINAL</span>:
        <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">CONST</span>:
        <span style="color: #0055FF;">case</span> TokenKind.<span style="">ABSTRACT</span>:
        <span style="color: #0055FF;">case</span> TokenKind.<span style="">FACTORY</span>:
          <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>modifiers == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> modifiers = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
          modifiers.<span style="">add</span><span style="color: #000033;">&#40;</span>_next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #0055FF; font-weight: bold;">break</span>;
        <span style="color: #0055FF; font-weight: bold;">default</span>:
          <span style="color: #0055FF; font-weight: bold;">return</span> modifiers;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  ParameterType typeParameter<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// non-recursive - so always starts from zero depth</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> myType = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">EXTENDS</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      myType = type<span style="color: #000033;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> tp = <span style="color: #0055FF; font-weight: bold;">new</span> TypeParameter<span style="color: #000033;">&#40;</span>name, myType, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> ParameterType<span style="color: #000033;">&#40;</span>name.<span style="">name</span>, tp<span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  List&lt;ParameterType&gt; typeParameters<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// always starts from zero depth</span>
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">bool</span> closed = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF;">var</span> ret = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">do</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> tp = typeParameter<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      ret.<span style="">add</span><span style="color: #000033;">&#40;</span>tp<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tp.<span style="">typeParameter</span>.<span style="">extendsType</span> is GenericTypeReference &amp;&amp;
          tp.<span style="">typeParameter</span>.<span style="">extendsType</span>.<span style="">dynamic</span>.<span style="">depth</span> == <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        closed = <span style="color: #0055FF; font-weight: bold;">true</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!closed<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">GT</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> ret;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #0055FF;">int</span> _eatClosingAngle<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">int</span> depth<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">GT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> depth;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>depth &gt; <span style="color: #cc66cc;">0</span> &amp;&amp; _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SAR</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> depth<span style="color: #cc66cc;">-1</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>depth &gt; <span style="color: #cc66cc;">1</span> &amp;&amp; _maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">SHR</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> depth<span style="color: #cc66cc;">-2</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'&gt;'</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> depth;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  addTypeArguments<span style="color: #000033;">&#40;</span>TypeReference baseType, <span style="color: #0055FF;">int</span> depth<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> _finishTypeArguments<span style="color: #000033;">&#40;</span>baseType, depth, <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  _finishTypeArguments<span style="color: #000033;">&#40;</span>TypeReference baseType, <span style="color: #0055FF;">int</span> depth, types<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> delta = <span style="color: #cc66cc;">-1</span>;
    <span style="color: #0055FF;">do</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> myType = type<span style="color: #000033;">&#40;</span>depth<span style="color: #cc66cc;">+1</span><span style="color: #000033;">&#41;</span>;
      types.<span style="">add</span><span style="color: #000033;">&#40;</span>myType<span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>myType is GenericTypeReference &amp;&amp; myType.<span style="">depth</span> &lt;= depth<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #808080; font-style: italic;">// TODO(jimhug): Friendly error if peek(COMMA).</span>
        delta = depth - myType.<span style="">depth</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>delta &gt;= <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      depth -= delta;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      depth = _eatClosingAngle<span style="color: #000033;">&#40;</span>depth<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> span = _makeSpan<span style="color: #000033;">&#40;</span>baseType.<span style="">span</span>.<span style="">start</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> GenericTypeReference<span style="color: #000033;">&#40;</span>baseType, types, depth, span<span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  typeList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> types = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">do</span> <span style="color: #000033;">&#123;</span>
      types.<span style="">add</span><span style="color: #000033;">&#40;</span>type<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> types;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  nameTypeReference<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> name;
    <span style="color: #0055FF;">var</span> names = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">var</span> typeArgs = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">var</span> isFinal = <span style="color: #0055FF; font-weight: bold;">false</span>;
&nbsp;
    <span style="color: #0055FF;">switch</span> <span style="color: #000033;">&#40;</span>_peek<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">VOID</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> SimpleTypeReference<span style="color: #000033;">&#40;</span>world.<span style="">voidType</span>, _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="">VAR</span>:
        <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> SimpleTypeReference<span style="color: #000033;">&#40;</span>world.<span style="">varType</span>, _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">case</span> TokenKind.<span style="color: #0055FF; font-weight: bold;">FINAL</span>:
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="color: #0055FF; font-weight: bold;">FINAL</span><span style="color: #000033;">&#41;</span>;
        isFinal = <span style="color: #0055FF; font-weight: bold;">true</span>;
        name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
      <span style="color: #0055FF; font-weight: bold;">default</span>:
        name = identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
        <span style="color: #0055FF; font-weight: bold;">break</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">DOT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>names == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> names = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
      names.<span style="">add</span><span style="color: #000033;">&#40;</span>identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> NameTypeReference<span style="color: #000033;">&#40;</span>isFinal, name, names, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  type<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#91;</span><span style="color: #0055FF;">int</span> depth = <span style="color: #cc66cc;">0</span><span style="color: #000033;">&#93;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> typeRef = nameTypeReference<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LT</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> addTypeArguments<span style="color: #000033;">&#40;</span>typeRef, depth<span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> typeRef;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  formalParameter<span style="color: #000033;">&#40;</span><span style="color: #0055FF;">bool</span> inOptionalBlock<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">int</span> start = _peekToken.<span style="">start</span>;
    <span style="color: #0055FF;">var</span> isThis = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF;">var</span> isRest = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF;">var</span> di = declaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> type = di.<span style="">type</span>;
    <span style="color: #0055FF;">var</span> name = di.<span style="">name</span>;
&nbsp;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>name == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'Formal parameter invalid'</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF;">var</span> value = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">ASSIGN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!inOptionalBlock<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'default values only allowed inside [optional] section'</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      value = expression<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_peekKind<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LPAREN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">var</span> formals = formalParameterList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">var</span> func = <span style="color: #0055FF; font-weight: bold;">new</span> FunctionDefinition<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span>, type, name, formals,
          <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      type = <span style="color: #0055FF; font-weight: bold;">new</span> FunctionTypeReference<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">false</span>, func, func.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>inOptionalBlock &amp;&amp; value == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      value = _makeLiteral<span style="color: #000033;">&#40;</span>Value.<span style="">fromNull</span><span style="color: #000033;">&#40;</span>_makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> FormalNode<span style="color: #000033;">&#40;</span>isThis, isRest, type, name, value, _makeSpan<span style="color: #000033;">&#40;</span>start<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  formalParameterList<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    _eatLeftParen<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> formals = <span style="color: #000033;">&#91;</span><span style="color: #000033;">&#93;</span>;
    <span style="color: #0055FF;">var</span> inOptionalBlock = <span style="color: #0055FF; font-weight: bold;">false</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACK</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        inOptionalBlock = <span style="color: #0055FF; font-weight: bold;">true</span>;
      <span style="color: #000033;">&#125;</span>
      formals.<span style="">add</span><span style="color: #000033;">&#40;</span>formalParameter<span style="color: #000033;">&#40;</span>inOptionalBlock<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF;">while</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">COMMA</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_maybeEat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">LBRACK</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
          <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>inOptionalBlock<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
            _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'already inside an optional block'</span>, _previousToken.<span style="">span</span><span style="color: #000033;">&#41;</span>;
          <span style="color: #000033;">&#125;</span>
          inOptionalBlock = <span style="color: #0055FF; font-weight: bold;">true</span>;
        <span style="color: #000033;">&#125;</span>
        formals.<span style="">add</span><span style="color: #000033;">&#40;</span>formalParameter<span style="color: #000033;">&#40;</span>inOptionalBlock<span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>inOptionalBlock<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RBRACK</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
      _eat<span style="color: #000033;">&#40;</span>TokenKind.<span style="">RPAREN</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> formals;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">// Type names are not allowed to use pseudo keywords</span>
  identifierForType<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_isIdentifier<span style="color: #000033;">&#40;</span>tok.<span style="">kind</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expected identifier, but found $tok'</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>tok.<span style="">kind</span> !== TokenKind.<span style="">IDENTIFIER</span> &amp;&amp; tok.<span style="">kind</span> != TokenKind.<span style="color: #0055FF; font-weight: bold;">NATIVE</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'$tok may not be used as a type name'</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> Identifier<span style="color: #000033;">&#40;</span>tok.<span style="">text</span>, _makeSpan<span style="color: #000033;">&#40;</span>tok.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  identifier<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> tok = _next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>!_isIdentifier<span style="color: #000033;">&#40;</span>tok.<span style="">kind</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expected identifier, but found $tok'</span>, tok.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
&nbsp;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> Identifier<span style="color: #000033;">&#40;</span>tok.<span style="">text</span>, _makeSpan<span style="color: #000033;">&#40;</span>tok.<span style="">start</span><span style="color: #000033;">&#41;</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
  <span style="color: #808080; font-style: italic;">// These last productions handle most ambiguities in grammar</span>
  <span style="color: #808080; font-style: italic;">// They will convert expressions into other types.</span>
  <span style="color: #808080; font-style: italic;">///////////////////////////////////////////////////////////////////</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/**
   * Converts an [Expression], [Formals] and a [Statment] body into a
   * [FunctionDefinition].
   */</span>
  _makeFunction<span style="color: #000033;">&#40;</span>expr, formals, body<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> name, type;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is VarExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      name = expr.<span style="">name</span>;
      type = <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is DeclaredIdentifier<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      name = expr.<span style="">name</span>;
      type = expr.<span style="">type</span>;
      <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>name == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
        _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expected name and type'</span>, expr.<span style="">span</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #000033;">&#125;</span>
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'bad function body'</span>, expr.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF;">var</span> span = <span style="color: #0055FF; font-weight: bold;">new</span> SourceSpan<span style="color: #000033;">&#40;</span>expr.<span style="">span</span>.<span style="">file</span>, expr.<span style="">span</span>.<span style="">start</span>, body.<span style="">span</span>.<span style="">end</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF;">var</span> func = <span style="color: #0055FF; font-weight: bold;">new</span> FunctionDefinition<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span>, type, name, formals, <span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>,
                                      body, span<span style="color: #000033;">&#41;</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> LambdaExpression<span style="color: #000033;">&#40;</span>func, func.<span style="">span</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Converts an expression to a [DeclaredIdentifier]. */</span>
  _makeDeclaredIdentifier<span style="color: #000033;">&#40;</span>e<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>e is VarExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span>, e.<span style="">name</span>, e.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>e is DeclaredIdentifier<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> e;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _error<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'expected declared identifier'</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">new</span> DeclaredIdentifier<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">null</span>, <span style="color: #0055FF; font-weight: bold;">null</span>, e.<span style="">span</span><span style="color: #000033;">&#41;</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
&nbsp;
  <span style="color: #808080; font-style: italic;">/** Converts an expression into a label. */</span>
  _makeLabel<span style="color: #000033;">&#40;</span>expr<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>expr is VarExpression<span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      <span style="color: #0055FF; font-weight: bold;">return</span> expr.<span style="">name</span>;
    <span style="color: #000033;">&#125;</span> <span style="color: #0055FF;">else</span> <span style="color: #000033;">&#123;</span>
      _errorExpected<span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'label'</span><span style="color: #000033;">&#41;</span>;
      <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #0055FF; font-weight: bold;">null</span>;
    <span style="color: #000033;">&#125;</span>
  <span style="color: #000033;">&#125;</span>
<span style="color: #000033;">&#125;</span>
&nbsp;
<span style="color: #0055FF; font-weight: bold;">class</span> IncompleteSourceException <span style="color: #0055FF; font-weight: bold;">implements</span> Exception <span style="color: #000033;">&#123;</span>
  <span style="color: #0055FF; font-weight: bold;">final</span> Token token;
&nbsp;
  IncompleteSourceException<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">token</span><span style="color: #000033;">&#41;</span>;
&nbsp;
  String toString<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>token.<span style="">span</span> == <span style="color: #0055FF; font-weight: bold;">null</span><span style="color: #000033;">&#41;</span> <span style="color: #0055FF; font-weight: bold;">return</span> <span style="color: #ff0000;">'Unexpected $token'</span>;
    <span style="color: #0055FF; font-weight: bold;">return</span> token.<span style="">span</span>.<span style="">toMessageString</span><span style="color: #000033;">&#40;</span><span style="color: #ff0000;">'Unexpected $token'</span><span style="color: #000033;">&#41;</span>;
  <span style="color: #000033;">&#125;</span>
<span style="color: #000033;">&#125;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/**
 * Stores a token stream that will be used by the parser. Once the parser has
 * reached the end of this [TokenSource], it switches back to the
 * [previousTokenizer]
 */</span>
<span style="color: #0055FF; font-weight: bold;">class</span> DivertedTokenSource <span style="color: #0055FF; font-weight: bold;">implements</span> TokenSource <span style="color: #000033;">&#123;</span>
  <span style="color: #0055FF; font-weight: bold;">final</span> List&lt;Token&gt; tokens;
  <span style="color: #0055FF; font-weight: bold;">final</span> Parser parser;
  <span style="color: #0055FF; font-weight: bold;">final</span> TokenSource previousTokenizer;
  DivertedTokenSource<span style="color: #000033;">&#40;</span><span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">tokens</span>, <span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">parser</span>, <span style="color: #0055FF; font-weight: bold;">this</span>.<span style="">previousTokenizer</span><span style="color: #000033;">&#41;</span>;
&nbsp;
  <span style="color: #0055FF;">int</span> _pos = <span style="color: #cc66cc;">0</span>;
  next<span style="color: #000033;">&#40;</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
    <span style="color: #0055FF;">var</span> token = tokens<span style="color: #000033;">&#91;</span>_pos<span style="color: #000033;">&#93;</span>;
    ++_pos;
    <span style="color: #0055FF;">if</span> <span style="color: #000033;">&#40;</span>_pos == tokens.<span style="">length</span><span style="color: #000033;">&#41;</span> <span style="color: #000033;">&#123;</span>
      parser.<span style="">tokenizer</span> = previousTokenizer;
    <span style="color: #000033;">&#125;</span>
    <span style="color: #0055FF; font-weight: bold;">return</span> token;
  <span style="color: #000033;">&#125;</span>
<span style="color: #000033;">&#125;</span>
&nbsp;</pre>